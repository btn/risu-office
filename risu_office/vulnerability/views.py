from datetime import date, datetime, timedelta
from django.core import serializers
from django.utils import simplejson
from django.db.models import Count
from django.http import HttpResponse
from vulnerability.models import Hosts, Items, Plugins


def json(request):
    json = {'info': {}, 'top_10': {}, 'vulnerabilities': {}}

    #Info
    json['info']['nclose_logo'] = 'nclose_logo.png'
    json['info']['company_logo'] = 'company_logo.png'
    json['info']['date'] = datetime.now().strftime('%B %Y')
    json['info']['assets_scanned'] = Hosts.objects.all().count()

    #Top 10 vulnerable servers
    top10_hosts = Hosts.objects.filter(netbios__isnull=False).values('netbios')\
        .annotate(value=Count('items')).order_by('-value', 'netbios')[:10]
    for host in top10_hosts:
        host['key'] = host.pop('netbios')
    json['top_10']['vulnerable_servers'] = list(top10_hosts)

    #Vulnerability by severity
    summa = Items.objects.filter(severity__in=[1, 2, 3]).count()
    high = Items.objects.filter(severity=1).count() * 100 / summa
    medium = Items.objects.filter(severity=2).count() * 100 / summa
    low = Items.objects.filter(severity=3).count() * 100 / summa
    decsription = 'Homines plous oinvorsei virei atquemuli eres sacra ne quisquam\
 ecise velet, neve inter ibei virei plous duobus, mulieribus plous tribus arfuise\
 velent, nisei de praitoris urbani senatuosque sententiad, utei suprad scriptum est.'
    json['vulnerabilities']['severity'] = {}
    json['vulnerabilities']['severity']['description'] = decsription
    json['vulnerabilities']['severity']['data'] = [
        {'value': high, 'key': 'high'},
        {'value': medium, 'key': 'medium'},
        {'value': low, 'key': 'low'}
    ]

    #Top 5 high risk vulnerabilities
    top5_risk = Plugins.objects.filter(risk_factor='High').annotate(value=Count('items'))\
        .values('value', 'plugin_name').order_by('-value', 'plugin_name')[:5]
    for risk in top5_risk:
        risk['description'] = risk.pop('plugin_name')
    json['vulnerabilities']['high_risk'] = list(top5_risk)

    #Vulnerabilities by risk
    high_time = Items.objects.filter(plugin__risk_factor='High')\
        .values_list('host__end', flat=True)
    points = []
    for time in high_time:
        add_day = 7 - time.isoweekday() + 1
        new_date = time + timedelta(days=add_day)
        points.append(new_date.strftime('%d/%m/%y'))
    set_points = list(set(points))
    high_risk_data = []
    for set_point in set_points:
        count = 0
        for point in points:
            if set_point == point:
                count += 1
        high_risk_data.append({'value': count, 'key': set_point})
    medium_time = Items.objects.filter(plugin__risk_factor='Medium')\
        .values_list('host__end', flat=True)
    points = []
    for time in medium_time:
        add_day = 7 - time.isoweekday() + 1
        new_date = time + timedelta(days=add_day)
        points.append(new_date.strftime('%d/%m/%y'))
    set_points = list(set(points))
    medium_risk_data = []
    for set_point in set_points:
        count = 0
        for point in points:
            if set_point == point:
                count += 1
        medium_risk_data.append({'value': count, 'key': set_point})
    critical_time = Items.objects.filter(plugin__risk_factor='Critical')\
        .values_list('host__end', flat=True)
    points = []
    for time in critical_time:
        add_day = 7 - time.isoweekday() + 1
        new_date = time + timedelta(days=add_day)
        points.append(new_date.strftime('%d/%m/%y'))
    set_points = list(set(points))
    critical_risk_data = []
    for set_point in set_points:
        count = 0
        for point in points:
            if set_point == point:
                count += 1
        critical_risk_data.append({'value': count, 'key': set_point})
    json['vulnerabilities']['by_risk'] = {}
    json['vulnerabilities']['by_risk']['series'] = []
    json['vulnerabilities']['by_risk']['series']\
        .append({'name': 'high', 'data': high_risk_data})
    json['vulnerabilities']['by_risk']['series']\
        .append({'name': 'medium', 'data': medium_risk_data})
    json['vulnerabilities']['by_risk']['series']\
        .append({'name': 'critical', 'data': critical_risk_data})

    #Top 5 vulnerable servers
    last_date = Hosts.objects.latest('end')
    end_date = last_date.end
    start = end_date + timedelta(days=-3*30)
    start_date = datetime(start.year, start.month, 01, 0, 0, 0, 0)
    months = Hosts.objects.filter(end__range=(start_date, end_date)).dates('end', 'month')
    json['vulnerabilities']['servers'] = []

    for month in months:
        values = Hosts.objects\
            .filter(netbios__isnull=False, end__year=month.year, end__month=month.month)\
            .values('netbios').annotate(value=Count('items'))\
            .order_by('-value', 'netbios')[:5]
        for value in values:
            del value['value']
            value['name'] = value.pop('netbios')
            value['count'] = 1
        json['vulnerabilities']['servers']\
            .append({'series': month.strftime('%B'), 'values': list(values)})

    #Number of hosts scanned
    hosts_time = Hosts.objects.values_list('end', flat=True)
    points = []
    for time in hosts_time:
        add_day = 7 - time.isoweekday() + 1
        new_date = time + timedelta(days=add_day)
        points.append(new_date.strftime('%d/%m/%y'))
    set_points = list(set(points))
    hosts_scanned_data = []
    for set_point in set_points:
        count = 0
        for point in points:
            if set_point == point:
                count += 1
        hosts_scanned_data.append({'value': count, 'key': set_point})
    json['vulnerabilities']['hosts_scanned'] = {}
    json['vulnerabilities']['hosts_scanned']['series'] = []
    json['vulnerabilities']['hosts_scanned']['series']\
        .append({'name': 'hosts', 'data': hosts_scanned_data})

    content = simplejson.dumps(json)
    return HttpResponse(content, content_type='application/json')

