from django.core import serializers
from django.utils import simplejson
from django.db.models import Count
from django.http import HttpResponse
from vulnerability.models import Hosts, Items


def table(request):
    versions = Items.objects.all()[:200]
    content = serializers.serialize('json', versions)
    return HttpResponse(content, content_type='application/json')


def json(request):
    json = {'info': {}, 'top_10': {}, 'vulnerabilities': {}}

    top10_hosts = Hosts.objects.filter(netbios__isnull=False).values('netbios')\
        .annotate(value=Count('items')).order_by('-value')[:10]
    for host in top10_hosts:
        host['key'] = host.pop('netbios')
    json['top_10']['vulnerable_servers'] = list(top10_hosts)

    summa = Items.objects.filter(severity__in=[1, 2, 3]).count()
    high = Items.objects.filter(severity=1).count() * 100 / summa
    medium = Items.objects.filter(severity=2).count() * 100 / summa
    low = Items.objects.filter(severity=3).count() * 100 / summa
    decsription = 'Homines plous oinvorsei virei atquemuli eres sacra ne quisquam ecise velet, neve inter ibei virei plous duobus, mulieribus plous tribus arfuise velent, nisei de praitoris urbani senatuosque sententiad, utei suprad scriptum est.'
    json['vulnerabilities']['severity'] = {}
    json['vulnerabilities']['severity']['description'] = decsription
    json['vulnerabilities']['severity']['data'] = [
        {'value': high, 'key': 'high'},
        {'value': medium, 'key': 'medium'},
        {'value': low, 'key': 'low'}
    ]

    content = simplejson.dumps(json)
    return HttpResponse(content, content_type='application/json')

